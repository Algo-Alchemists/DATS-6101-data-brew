---
title: "Midterm_Project_T6"
output: html_document
date: "2023-10-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data Brew: Brewing Success with Starbucks Customer Insights

The data is contained in three files:

portfolio.csv - data about offers sent to customers (10 offers x 6 columns)

profile.csv - demographic data of customers (17,000 customers x 5 columns)

transcript.csv - customer response to offers and transactions made (306,648 events x 4 columns)

```{r, results='markup'}
# Importing and reading the Datasets 
df_cust_offer<-read.csv("data/transcript.csv")
head(df_cust_offer)
print("The structure of Transcript:")
str(df_cust_offer)

df_offers<-read.csv("data/portfolio.csv")
head(df_offers)
print("The structure of Portfolio:")
str(df_offers)

df_cust<-read.csv("data/profile.csv")
head(profile)
print("The structure of Profile:")
str(profile)
```

```{r, results='markup'}
#Checking for the Missing values in each column of the dataframes
cust_offer_missing_values <- colSums(is.na(df_cust_offer))
print("Missing values in transcript:")
print(cust_offer_missing_values)


offers_missing_values <- colSums(is.na(df_offers))
print("Missing values in portfolio:")
print(offers_missing_values)


df_cust$gender[df_cust$gender == ""] <- NA #Filling empty spaces with NA values
cust_missing_values <- colSums(is.na(df_cust))
print("Missing values in profile:")
print(cust_missing_values)
```

```{r}
#Checking count of missing values if they are from the same observations
missing_gender_and_income <- sum(is.na(df_cust$gender) & is.na(df_cust$income))
print("Count of missing values in both gender and income:")
print(missing_gender_and_income)
```

```{r}
missing_gender_and_income_together <- df_cust[is.na(df_cust$gender) & is.na(df_cust$income), ]
head(missing_gender_and_income_together)
```

```{r}
missing_gender_and_income_together <- df_cust[is.na(df_cust$gender) & is.na(df_cust$income), ]
head(missing_gender_and_income_together)
```

```{r}
#Remove NA values
df_cust_updated <- na.omit(df_cust)
head(df_cust_updated)
```

```{r}
#Checking the columns with numerical data 
numcols <- names(df_cust_updated)[sapply(df_cust_updated, is.numeric)]
head(numcols)
```

```{r}
#Converting became_member_on to datetime format
df_cust_updated$became_member_on <- as.Date(as.character(df_cust_updated$became_member_on), format = "%Y%m%d")
head(df_cust_updated)
```

```{r}
#Drop the unnecessary first Column in transcript
df_cust_offer <- df_cust_offer[, -1]
head(df_cust_offer)
```

```{r}
#check transcript data frame data types
df_cust_offer_dtypes <- sapply(df_cust_offer, class)
print(df_cust_offer_dtypes)
```

```{r}
#convert time in hours to number of days 
library(dplyr)
df_cust_offer <- df_cust_offer %>% 
  mutate(time = time / 24)
```

```{r}
#Rename columns 
colnames(df_cust_offer)[colnames(df_cust_offer) == "time"] <- "days_elapsed"
colnames(df_cust_offer)[colnames(df_cust_offer) == "person"] <- "customer_id"
tail(df_cust_offer)
```

## **Data Transformation:**

### **Transform `df_offers`**

Add an alias to each offer for easier recognition and referencing.

```{r}
#before transforming
head(df_offers)
```

```{r}
# Load required library
library(dplyr)
# Sort df_offer by offer_type and difficulty
df_offers <- df_offers %>%
  arrange(offer_type, difficulty) %>%
  mutate(index = row_number()) %>%
  select(-index)

# Add the offer_alias column
df_offers$offer_alias <- LETTERS[1:nrow(df_offers)]
head(df_offers)
```


```{r}
# Extract the 'customer_id' and 'event' columns
df_cust_offer_subset <- df_cust_offer[, c("customer_id", "event","days_elapsed")]
 
# Split the 'value' column into 'value_key' and 'value_data'
df_cust_offer_subset$value_key <- sapply(strsplit(df_cust_offer$value, "[:,]") , "[[", 1)
df_cust_offer_subset$value_data <- sapply(strsplit(df_cust_offer$value, "[:,]") , "[[", 2)
 
# Remove any leading/trailing white spaces
df_cust_offer_subset$value_key <- trimws(df_cust_offer_subset$value_key)
df_cust_offer_subset$value_data <- trimws(df_cust_offer_subset$value_data)
 
# Remove unwanted characters, including brackets and spaces, from 'value_key' and 'value_data'
df_cust_offer_subset$value_key <- gsub("[{}',\";]", "", df_cust_offer_subset$value_key)
df_cust_offer_subset$value_data <- gsub("[{}',\";]", "", df_cust_offer_subset$value_data)
# Display the resulting data frame
head(df_cust_offer_subset)
```
```{r}
df_cust_offer<- df_cust_offer_subset
head(df_cust_offer)
```
## **EDA on transcripts data:**

```{r}
library(ezids)
# Get value counts for the 'event' column
event_value_counts <- table(df_cust_offer$event)

# Print the value counts
xkabledply(event_value_counts)

```
```{r}
library(ggplot2)

# Create a data frame from the event counts
event_counts_df <- data.frame(event = names(event_value_counts), count = as.numeric(event_value_counts))

# Create a bar chart using ggplot
ggplot(event_counts_df, aes(x = event, y = count)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Bar Chart of Event Counts", x = "Event", y = "Count") +
  theme_minimal()+
  scale_y_continuous(breaks = seq(0, max(event_counts_df$count), by = 20000))



```
Observations:

1. The dataset contains 138,953 transactions, which is more than four times the number of completed offers. This suggests that many customers made multiple purchases without the influence of an offer. This indicates a high level of customer loyalty, which is expected, given that Starbucks primarily offers fast-moving consumer goods such as coffee and food.

2. During the campaign month, around 76,277 offers were sent to customers, and a remarkable 76% of these offers were viewed by customers. This high view rate reflects active customer engagement and suggests that the promotional slogans and design were effective in attracting customer attention.

3. And 33,579 offers were completed, accounting for 58% of the viewed offers and 44% of all the offers sent. This relatively high offer completion rate is indicative of strong customer loyalty, likely indicating a substantial number of regular customers who regularly participate in Starbucks' promotions.


```{r}

#Print min and max of days elapsed
min_days_elapsed <- min(df_cust_offer$days_elapsed)
max_days_elapsed <- max(df_cust_offer$days_elapsed)

cat("Minimum days_elapsed:", min_days_elapsed, "\n")
cat("Maximum days_elapsed:", max_days_elapsed, "\n")

```
```{r}
library(ggplot2)
# Create a histogram
ggplot(df_cust_offer, aes(x = days_elapsed)) +
  geom_histogram(bins = 30, fill = "brown", color = "black") +
  labs(x = "Days", y = "Events Count", title = "Events Occurrence over Time") +
  theme_minimal() +
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 14), plot.title = element_text(size = 16))

```

The above plot reveals six distinct peaks of events during the campaign, primarily associated with the reception of offers, followed by subsequent events like offer views, completions, and purchases.
